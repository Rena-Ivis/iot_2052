# 1.1 Лабораторная работа: начало работы с микроконтроллером
## 1.1.1 Описание практикума
### Цели работы
Рассмотреть оборудование, которое будет использоваться в дальнейшем, а так же разобрать код простейшей программы.

Все проекты будут выполняться с использованием SoC ESP32.
В качестве IDE будет использоваться VS Code с добавлением расширения ESP-IDF.

Рассмотрим подробнее, что потребуется в этой работе.
Итак, из аппаратного обеспечения нам понадобится:

* плата на базе ESP32;
* кабель USB A / micro USB B (или USB Type-C на некоторых современных платах);
* компьютер под управлением операционной системы Windows, Linux или macOS.

Для успешного написания программы и программирования микроконтроллеров серии ESP32 на хост-компьютере должны быть установлены:

* набор инструментов (toolchain) для компиляции кода для ESP32;
* инструменты сборки – CMake и Ninja для сборки полноценного приложения для ESP32;
* ESP-IDF, который по сути содержит API (библиотеки программного обеспечения и исходный код) для ESP32 и скрипты для работы набора инструментов.
  
![image](img/ide.png)

### ESP32-S3 for UNO

ESP32-S3 for UNO — это, по сути, ESP32-S3 в форм-факторе Arduino UNO (совместимая по разъёмам). Это важно, так как она совместима со стандартными шилдами Arduino UNO например, Grove Base Shield V2 - который будет задействован в курсе в дальнейшем. Помимо этого плата содержит в себе - Wi-Fi и BLE 5.0, следовательно их не придется подключать отдельными модулями

![image](img/esp32.webp)

## 1.1.2 Hello World — компиляция и загрузка программы

Порядок установки и создания первой программы:
1. Установите [Visual Studio Code](https://code.visualstudio.com/)
2. В самой IDE программе необходимо установить расширение ESP-IDF. Открываем менеджер расширений, в строке поиска указываем esp-idf, и для найденного расширения нажимаем кнопку Install, а после успешной установки расширения в боковой панели Visual Studio Code появится иконка расширения ESP-IDF, которую и следует нажать.
3. При первом запуске расширения ESP-IDF предлагается установить все необходимые компоненты. Предлагается 3 варианта установки: Express (самый простой, все настройки по умолчанию), Advanced (придётся указать ряд параметров самостоятельно) и Use Existing Setup – использовать существующую установку (что может быть полезно, если, например, уже установлена IDE ESP-IDF или вариант с Eclipse). Воспользуется самым простым вариантом – Espress. Если вдруг в дальнейшем понадобится снова настроить конфигурацию, например, установить другую (хоть новую, хоть старую) версию фреймворка, то сделать это можно в боковом меню Configure ESP-IDF Extension.
4. Выбираем в качестве источника, откуда будут скачиваться и устанавливаться необходимые компоненты, Github, выбираем версию фреймворка - последнюю доступную (текущая 5.5). Если все хорошо, то нажимаем Install и ждём окончания процесса скачивания и установки. Может потребоваться достаточно большой период времени, так как предстоит скачать ~2 Гб.
5. После установки в меню команд выбираем New Project Wizard, указываем имя проекта – например hello_world (пробелы, кириллицу и т.д. не используем!), проверяем, чтобы директория проекта не содержала не-ASCII символов, при необходимости меняем каталог. В поле Choose ESP-IDF Board выбираем Custom board, а в поле OpenOCD Configuration files (Relative paths to OPENOCD_SCRIPTS) пишем - `board/esp32-wrover-kit-3.3v.cfg`. Теперь переходим далее нажимая Choose Template
6. Из предложенных вариантов выбираем template-app - по сути пустой проект.
7. Раскроем дерево проекта, выберем файл main.c и посмотрим его содержимое - каркас пустой программы. Заменим текст файла main.c на следующий код программы:
```
#include <stdio.h>
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"

void app_main(void)
{
    int i = 0;
    printf("Hello world!\n");
    while (1)
    {
        printf("This program runs since %d seconds.\n", i++); 
        vTaskDelay(1000 / portTICK_PERIOD_MS);
    }
}
```
Программы для встраиваемых устройств работают с момента включения устройства и до его выключения. Поэтому практически всегда такая программа содержит бесконечный цикл, внутри которого и выполняются все операции. Всё что до цикла – это действия, которые нужно выполнить однократно при включении устройства. К примеру, это может быть инициализация необходимых переменных, что и сделано в этом примере. Также однократно выводится текстовое сообщение Hello world! А дальше, в бесконечном цикле, заданном оператором while, осуществляется вывод текстового сообщения, говорящего о том, сколько секунд прошло с момента запуска программы.

Следует также обратить внимание на то, что в цикле используется вызов функции vTaskDelay(). Данная функция формирует задержку выполнение программы на указанное в её аргументе время. В нашем примере это 1000 мс или же 1 с. Функция vTaskDelay() является частью API FreeRTOS, а потому в начале программы подключаются заголовочные файлы FreeRTOS.h и task.h. Константа portTICK_PERIOD_MS задает сколько отсчетов системного таймера (сколько тиков) составляет период в 1 мс.

8. Ознакомимся с панелью инструментов ESP-IDF. В Visual Studio Code она располагается снизу.
![image](img/panel.png)
9. Запускаем процесс компиляции и сборки проекта. При успешной сборке на вкладке OUTPUT, которая открывается по умолчанию, будет выведено соответствующее сообщение и на некоторое время появится всплывающее окно с сообщением об успешном окончании операции сборки. Также при успешной сборке на вкладке TERMINAL отображается информация о распределении памяти микроконтроллера.
10. Убедиться в работоспособности оборудования и узнать, какой номер порта назначен плате, которую подключили к компьютеру, в ОС Windows можно запустив Диспетчер устройств. На основе этой информации нужно выбрать соответствующий порт в проекте и метод программирования (UART).

![image](img/win_dev_manager.png)
11. Программируем микроконтроллер – заливаем прошивку. Информацию об окончании процесса загрузки прошивки (Flash Done) можно увидеть на вкладке OUTPUT и во всплывающем окне. Переходим к монитору последовательного порта, к которому подключена плата – именно через него на вкладке TERMINAL можно наблюдать вывод программы.

Полезные ресурсы:
- [Wokwi](https://wokwi.com/projects/new/esp-idf-esp32) - эмулятор работы микроконтролера и ряда компонентов
- [PICSimLab - Prog. IC Simulator Lab.](https://sourceforge.net/projects/picsim/) - офлайн эмулятор
